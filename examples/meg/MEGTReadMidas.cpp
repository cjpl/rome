//// Author: Matthias Schneebeli
////////////////////////////////////////////////////////////////////////////////
//                                                                            //
// MEGTReadMidas                                                              //
//                                                                            //
// Reads Midas Data.                                                            
//                                                                            //
//                                                                            //
// This file has been generated by the ROMEBuilder.                           //
//                                                                            //
// This task contains the following histgrams :
//
// The histograms are created and saved automaticaly by the task.
//
// The following methods can be used to fill the histogram and to set the
// right name,title and binwidth of the histogram :
//
// Fill<Histogram Name>(double value,double weight)
//
// For histogram arrays use :
//
// Fill<Histogram Name>At(int index,double value,double weight)
//
// If more histogram functions are needed use the following function the get
// a handle to the histogram and use the root functions.
//
// Get<Histogram Name>Handle()
//
// For histogram arrays use :
//
// Get<Histogram Name>HandleAt(int index)
//                                                                            //
/////////////////////////////////////----///////////////////////////////////////

#if defined( _MSC_VER )
#include <io.h>
#define O_RDONLY_BINARY O_RDONLY | O_BINARY
#endif
#if defined ( __linux__ )
#include <unistd.h>
#include <stdlib.h>
#include <sys/io.h>
#include <sys/types.h>
#include <sys/stat.h>
#define O_RDONLY_BINARY O_RDONLY
#endif

#include <TFile.h>
#include <ROME.h>
#include <ROMEStatic.h>
#include "MEGTReadMidas.h"
#include "MEG.h"
#include <Riostream.h>

ClassImp(MEGTReadMidas)


void MEGTReadMidas::Init()
{
}

void MEGTReadMidas::BeginOfRun()
{
}

void MEGTReadMidas::Event()
{
   // Read Midas Banks and fill theme to folder

   Int_t i;
   Float_t  vfTDC[gNumberOfPMT];
   int channel=0;float time=0,k;
   int n_f,n_c,n_v;

   // set trigger values
   fAnalyzer->SetTriggerObject(fAnalyzer->GetEventHeader()->event_id,fAnalyzer->GetEventHeader()->trigger_mask,
                               fAnalyzer->GetEventHeader()->time_stamp,fAnalyzer->GetEventHeader()->serial_number);

   // Read Banks

   // TDC Banks
   n_f = fAnalyzer->GetFTDCBankEntries();
   n_c = fAnalyzer->GetCTDCBankEntries();
   if (n_f == gNumberOfFTDC && n_c == gNumberOfCTDC) {
      for (i=gNumberOfFTDC;i<gNumberOfPMT;i++) vfTDC[i] = INVALID;
 
      // FTDC Bank
      for (i=0;i<gNumberOfFTDC;i++) {
         vfTDC[i] = (Float_t)(0.025f*fAnalyzer->GetFTDCBankAt(i)->data);
      }

      // CTDC Bank
      for (i=0;i<gNumberOfCTDC;i++) {
         for (k=0,channel=0 ; k<5 && (int)(fAnalyzer->GetCTDCBankAt(i)>>16) != 19+k ; k++){
            channel += 16;
         }
         channel += (fAnalyzer->GetCTDCBankAt(i) >> 12) & 0xF;
         channel += gNumberOfFTDC;
         time = (float) (fAnalyzer->GetCTDCBankAt(i) & 0xFFF);
         if (time >= 1.f && time < 4096.0f) {
            time *= 0.025f;
            if(channel < gNumberOfFTDC + gNumberOfCTDC) {
               vfTDC[channel] = time;
            }
         }
         else vfTDC[channel] = INVALID;
      }

      // VTDC Bank
      n_v = fAnalyzer->GetVTDCBankEntries();
      for (i=0;i<n_v;i++) {
         if(fAnalyzer->GetVTDCBankAt(i)->tag == 0) {//( tag = 0:data, 2:header, 4:EOB 
	         channel = gNumberOfFTDC + gNumberOfCTDC; // put VME TDCs after FB&Camac TDCs 
	         channel += fAnalyzer->GetVTDCBankAt(i)->geo_addr*32;
	         channel += fAnalyzer->GetVTDCBankAt(i)->channel;
	         time = fAnalyzer->GetVTDCBankAt(i)->data;
	         // convert to ns 
	         time *= 0.035f;
	         if (channel < gNumberOfPMT) {
               // fill histos with TDC value 
	            vfTDC[channel] = time;
            }
         }
      }
   }
   else {
      fAnalyzer->GetCMPMTDataTree()->SetFillEvent(false);
      return;
   }
   // write data to folder
   int iadc,itdc;
   for (i=0;i<gNumberOfPMT;i++) {
      iadc = fAnalyzer->GetCMPMTInfoAt(i)->GetADCID();
      itdc = fAnalyzer->GetCMPMTInfoAt(i)->GetTDCID();
      fAnalyzer->SetCMPMTDataObject(i,(Float_t)fAnalyzer->GetADC0BankAt(iadc),(Float_t)fAnalyzer->GetADC1BankAt(iadc),vfTDC[itdc]);
   }
   fAnalyzer->SetCMRefObject(fAnalyzer->GetTriggerObject(),
                             fAnalyzer->GetCMScalerObject(),
                             fAnalyzer->GetCMHVObject(),
                             fAnalyzer->GetEnvironmentObject());
	  
   return;
}

void MEGTReadMidas::EndOfRun()
{
}

void MEGTReadMidas::Terminate()
{
}


